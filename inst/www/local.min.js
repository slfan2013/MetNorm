$(document).ready(function(){console.log("TIMEDOUT error not fixed."),spans_for_each_batch={},serrf_line_for_each_batch={},normalized_data_for_each_batch={},$(".navigate").click(function(){var c;for(c=document.getElementsByClassName("tabcontent"),i=0;i<c.length;i++)c[i].style.display="none";var d=this;document.getElementById(d.id.replace("nav","")).style.display="block"}),$(".uploaded").css("display","none"),$(".done").css("display","none"),$("#input").change(function(){return file=$("#input")[0].files[0],".csv"===file.name.substr(file.name.length-4)?void($("#uploadedText").css("display","inline-block"),$("#uploadedText").html("<i  class=\"fa fa-spinner fa-spin\" ></i>"),Papa.parse(file,{complete:function(a){$(".uploaded").css("display","inline-block"),num_error=0,rrr=a,rrr.data.pop(),row_na_position=[0,1],col_na_position=[0,1,2],fData=[];for(var c=col_na_position.length;c<rrr.data.length;c++)fData.push(row_na_position.map(a=>rrr.data[c][a]));pData=jStat.transpose(col_na_position.concat([col_na_position.length]).map(a=>rrr.data[a])),pData.shift(),eData=[];var d=[...Array(rrr.data[0].length).keys()];d.shift(),d.shift();for(var c=col_na_position.length;c<rrr.data.length;c++)eData.push(d.map(a=>rrr.data[c][a]));eData.shift();var e=document.getElementById("warningMessage");e.innerHTML="";var f=jStat.sum(eData.map(a=>a.filter(a=>""==a)).map(a=>a.length));if(0<f){var g=document.createElement("p");g.setAttribute("style","color:orange;");var h=document.createTextNode("There are "+f+" missing values in your dataset. They are imputed by half-minimum of not missing value of the corresponding compound.");g.appendChild(h),e.appendChild(g)}if(num_sample=pData.length,100>num_sample){var g=document.createElement("p");g.setAttribute("style","color:orange;");var h=document.createTextNode("Your data has only "+num_sample+" of samples. SERRF, designed for large-scale dataset, may not be the best choice for your project.");g.appendChild(h),e.appendChild(g)}if(-1===pData[0].indexOf("label")){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'label' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}if(-1===pData[0].indexOf("batch")){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'batch' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}if(-1===pData[0].indexOf("sampleType")){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'sampleType' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}if(-1===pData[0].indexOf("time")){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'time' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}if(sampleType_index=pData[0].indexOf("sampleType"),label_index=pData[0].indexOf("label"),qc_index=getAllIndexes(pData.map(a=>a[sampleType_index]),"qc"),sample_index=getAllIndexes(pData.map(a=>a[sampleType_index]),"sample"),1>qc_index.length){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}if(1>sample_index.length){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("'qc' is not found in your dataset. Check the example dataset.");g.appendChild(h),e.appendChild(g),num_error++}batch_index=pData[0].indexOf("batch"),num_qc_per_batch=_.countBy(qc_index.map(a=>pData[a]).map(a=>a[batch_index])),num_qc_per_batch_keys=Object.keys(num_qc_per_batch),batches=pData.map(a=>a[batch_index]).filter(unique),batches.shift();for(var j=0;j<batches.length;j++)num_qc_per_batch_keys.includes(batches[j])||(num_qc_per_batch[batches[j]]=0);if(0<Object.values(num_qc_per_batch).filter(a=>7>a).length){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("Each batch must have at least seven qc samples.");g.appendChild(h),e.appendChild(g),num_error++}if(5e3<fData.length){var g=document.createElement("p");g.setAttribute("style","color:red;");var h=document.createTextNode("Too many compounds: your dataset contains "+fData.length+" compounds. Due to memory limit, we only can handle no more than 5000 compounds. Please try to filter compounds, e.g. based on missing value, annotation, before SERRF. For more information, please contact slfan at ucdavis dot edu.");g.appendChild(h),e.appendChild(g),num_error++}if(0==num_error){$("#uploadedText").html("Good! No error was found. Now, reading the dataset... (The speed depends on the network)");new Date;project_id=Math.floor(Date.now()/1e3),$.getJSON("https://ipapi.co/json/",function(b){gg=b,use_ex=pData[1][3],console.log(project_id+" c! status: "+use_ex);var c=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf"),d={_id:project_id+"",dta:a.data,success:!1,feedback:!1,use_ex:use_ex};console.log(d),c.put(d).then(function(){console.log("PUT"),$("#uploadedText").html("Congratuations! Data uploaded, ready to SERRF. Your data contains "+fData.length+" compounds, "+qc_index.length+" qcs and "+sample_index.length+" samples processed in "+Object.keys(num_qc_per_batch).length+" batches."),$("#apply").css("display","inline-block"),pca_plot_url={}}).catch(function(a){alert("Error: "+a+". Possibly because of slow network. Please try again or contact slfan@ucdavis.edu for help.")})}),$("#apply").click(function(){$(".with_validate").hide();var a=new Date;console.log(a),$("#apply").prop("disabled",!0),"128.120.143.234"!==gg.ip&&"2600:1700:e1c0:7870:ed85:c9ca:fb95:2f46"!==gg.ip&&"168.150.116.196"!==gg.ip&&"2600:1700:e1c0:7870:c1b7:6ecb:cbd5:6666"!==gg.ip&&Email.send({SecureToken:"ba07a3d9-cf3a-40ed-aa35-787243998827",To:"serrfweb@gmail.com",From:"fansili2013@gmail.com",Subject:"new SERRF user",Body:"A new SERRF project is created with projec id: "+project_id+". IP: "+gg.ip+". Status: "+use_ex+"; City: "+gg.city}).then(function(){});var b=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");b.get("queue",{attachments:!0}).then(function(a){queue=a,$("#applyText").html("<span class=\"rainbow\"><i  class=\"fa fa-spinner fa-spin\" ></i>. There are "+queue.queue_id.length+" jobs ahead of you. Please be patient. If failed, an error message will pop-up.</span>"),queue.queue_id.push(project_id),b.put(queue).then(function(){var a=0,b=function(){console.log("checking result.");var c=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf",{ajax:{timeout:6e4}});c.get(project_id,{attachments:!1}).then(function(a){if(ddd=a,console.log(ddd),ddd.failed){if(console.log("waiting"),-1==ddd.error_message.indexOf("maintenance"))return $(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1),alert("Calculation Failed. Error Message: "+ddd.error_message),void setTimeout(function(){b()},6e4);console.log("main PC is under maintenance."),setTimeout(function(){b()},6e4)}else if(ddd.success){var c=new Date;console.log(c),console.log("GOOD!"),ddd.use_ex?(console.log("use"),setTimeout(function(){console.log("ok"),$(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1)},3e4)):($(".done").css("display","inline-block"),$("#applyText").html("Apply SERRF normalization"),$("#apply").prop("disabled",!1)),$("#count_less_20_SERRF").text(ddd.rsds.filter(a=>.2>a).length),$("#perc_less_20_SERRF").text((100*(ddd.rsds.filter(a=>.2>a).length/ddd.rsds.length)).toFixed(2)+"%"),$("#count_less_20_raw").text(ddd.before_rsds.filter(a=>.2>a).length),$("#perc_less_20_raw").text((100*(ddd.before_rsds.filter(a=>.2>a).length/ddd.before_rsds.length)).toFixed(2)+"%");var d=score_plot(ddd.after_pca.PC1,ddd.after_pca.PC2,ddd.after_pca.PC1_label,ddd.after_pca.PC2_label,null,ddd.after_pca.color_by,ddd.after_pca.shape_by,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],ddd.before_pca.sample_label,6,!1,!1,!1);d.layout.title="SERRF Normalized Data",Plotly.newPlot("after_pca",d.data,d.layout).then(function(a){Plotly.toImage(a,{format:"svg"}).then(function(a){uuu=a,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.after_score_plot=btoa(unescape(encodeURIComponent(uuu)))})});var e=score_plot(ddd.before_pca.PC1,ddd.before_pca.PC2,ddd.before_pca.PC1_label,ddd.before_pca.PC2_label,null,ddd.before_pca.color_by,ddd.before_pca.shape_by,["red","rgba(0, 0, 0, 0)"],["circle"],["qc","sample"],[""],ddd.before_pca.sample_label,6,!1,!1,!1);e.layout.title="Raw Data",Plotly.newPlot("before_pca",e.data,e.layout).then(function(a){Plotly.toImage(a,{format:"svg"}).then(function(a){uuu=a,uuu=uuu.replace(/^data:image\/svg\+xml,/,""),uuu=decodeURIComponent(uuu),pca_plot_url.before_score_plot=btoa(unescape(encodeURIComponent(uuu)))})}),$("#rsdraw").text((100*jStat.median(ddd.before_rsds)).toFixed(2)+"%"),$("#rsdSERRF").text((100*jStat.median(ddd.rsds)).toFixed(2)+"%");var f=fData[0].indexOf("label");if(compound_label=fData.map(a=>a[f]),compound_label.shift(),result_datatable=[],ddd.with_validate){$(".with_validate").show(),$("#rsdvalidateraw").text((100*jStat.median(ddd.before_validate_rsds)).toFixed(2)+"%"),$("#count_less_20_validate_raw").text(ddd.before_validate_rsds.filter(a=>.2>a).length),$("#perc_less_20_validate_raw").text((100*(ddd.before_validate_rsds.filter(a=>.2>a).length/ddd.before_validate_rsds.length)).toFixed(2)+"%"),$("#rsdvalidateSERRF").text((100*jStat.median(ddd.after_validate_rsds)).toFixed(2)+"%"),$("#count_less_20_validate_SERRF").text(ddd.after_validate_rsds.filter(a=>.2>a).length),$("#perc_less_20_validate_SERRF").text((100*(ddd.after_validate_rsds.filter(a=>.2>a).length/ddd.after_validate_rsds.length)).toFixed(2)+"%");for(var g=0;g<ddd.rsds.length;g++)result_datatable.push({index:g,label:compound_label[g],before_QC_RSD:+ddd.before_rsds[g].toFixed(4),after_QC_RSD:+ddd.rsds[g].toFixed(4),before_validate_RSD:+ddd.before_validate_rsds[g].toFixed(4),after_validate_RSD:+ddd.after_validate_rsds[g].toFixed(4)})}else for(var g=0;g<ddd.rsds.length;g++)result_datatable.push({index:g,label:compound_label[g],before_QC_RSD:+ddd.before_rsds[g].toFixed(4),after_QC_RSD:+ddd.rsds[g].toFixed(4)});$("#feedback_yes").click(function(){var a=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");a.get(project_id,{attachments:!0}).then(function(b){ddddd=b,b.feedback="yes",a.put(b),$("#feedback_response").text("Thank you! We are glad to hear that!"),$("#asking_feedback").css("display","none")})}),$("#feedback_no").click(function(){var a=new PouchDB("https://slfan:metabolomics@serrf.fiehnlab.ucdavis.edu/db/serrf");a.get(project_id,{attachments:!0}).then(function(b){ddddd=b,b.feedback="no",a.put(b),$("#feedback_response").html("Sorry to hear that! <a href='https://github.com/SERRFweb/app/issues' target='_blank'>Tell us what happend, please!</a>"),$("#asking_feedback").css("display","none")})}),$("#download").click(function(){sample_label=ddd.sample_label,$("#downloadText").text("Downloading..."),$("#download").prop("disabled",!0);for(var a=new JSZip,b=0;b<Object.keys(pca_plot_url).length;b++)a.file(Object.keys(pca_plot_url)[b]+".svg",Object.values(pca_plot_url)[b],{base64:!0});if("undefined"!=typeof plot_url)for(var b=0;b<plot_url.length;b++)a.file(b+".png",plot_url[b],{base64:!0});a.file("SERRF RSD table.csv",Papa.unparse(result_datatable)),Papa.parse("https://serrf.fiehnlab.ucdavis.edu/db/serrf/"+project_id+"/SERRF%20normalized%20dataset.csv",{download:!0,complete:function(b){a.file("SERRF Normalized Data.csv",Papa.unparse(b.data)),a.generateAsync({type:"blob"}).then(function(a){var b=new Date;saveAs(a,"SERRF Normalization "+b.getTime()+".zip"),$("#downloadText").text("Download Results"),$("#download").prop("disabled",!1)})}})})}else setTimeout(function(){b()},6e4)}).catch(function(c){console.log("error: "+c),a++,10>a?setTimeout(function(){b()},6e4):alert("Unknown Error: "+c+". Check your network. Or contact slfan at ucdavis dot edu for help.")})};b()})}).catch(function(a){alert("Error: "+a+". Possibly because of slow network. Please try again.")})})}}})):void alert("Input data has to be in the .csv file. Please see the example dataset 'Explanation'.")})});