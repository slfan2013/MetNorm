(function(){function a(m,n){for(var o in n||(n={}),m)void 0===n[o]&&(n[o]=m[o]);return n}function b(){this._callbacks=[],this._errCallbacks=[],this._resolved=0,this._result=null}function c(m,n){this.data=m,this.options=a(l,n),this.operation=new b,this.operation.resolve(null,this.data),this.requiredScripts=[],this.requiredFunctions=[]}var d='undefined'!=typeof module&&module.exports,f='undefined'==typeof window||this!==window,g=g||function(m){setTimeout(m,0)},h=f?require(__dirname+'/Worker.js'):self.Worker,j='undefined'==typeof self?null:self.URL?self.URL:self.webkitURL,k=f||self.Worker;b.prototype.resolve=function(m,n){if(!m){this._resolved=1,this._result=n;for(var o=0;o<this._callbacks.length;++o)this._callbacks[o](n)}else{this._resolved=2,this._result=m;for(var p=0;p<this._errCallbacks.length;++p)this._errCallbacks[p](m)}this._callbacks=[],this._errCallbacks=[]},b.prototype.then=function(m,n){return 1===this._resolved?void(m&&m(this._result)):2===this._resolved?void(n&&n(this._result)):(m&&(this._callbacks[this._callbacks.length]=m),n&&(this._errCallbacks[this._errCallbacks.length]=n),this)};var l={evalPath:f?__dirname+'/eval.js':null,maxWorkers:f?require('os').cpus().length:navigator.hardwareConcurrency||4,synchronous:!0,env:{},envNamespace:'env'};c.isSupported=function(){return k},c.prototype.getWorkerSource=function(m,n){var o=this,p='',q=0;for(f||0===this.requiredScripts.length||(p+='importScripts("'+this.requiredScripts.join('","')+'");\r\n'),q=0;q<this.requiredFunctions.length;++q)p+=this.requiredFunctions[q].name?'var '+this.requiredFunctions[q].name+' = '+this.requiredFunctions[q].fn.toString()+';':this.requiredFunctions[q].fn.toString();n=JSON.stringify(n||{});var r=this.options.envNamespace;return f?p+'process.on("message", function(e) {global.'+r+' = '+n+';process.send(JSON.stringify(('+m.toString()+')(JSON.parse(e).data)))})':p+'self.onmessage = function(e) {var global = {}; global.'+r+' = '+n+';self.postMessage(('+m.toString()+')(e.data))}'},c.prototype.require=function(){for(var n,m=Array.prototype.slice.call(arguments,0),o=0;o<m.length;o++)n=m[o],'string'==typeof n?this.requiredScripts.push(n):'function'==typeof n?this.requiredFunctions.push({fn:n}):'object'==typeof n&&this.requiredFunctions.push(n);return this},c.prototype._spawnWorker=function(m,n){var o,p=this.getWorkerSource(m,n);if(f)o=new h(this.options.evalPath),o.postMessage(p);else{if(h===void 0)return;try{if(0!==this.requiredScripts.length){if(null!==this.options.evalPath)o=new h(this.options.evalPath),o.postMessage(p);else throw new Error('Can\'t use required scripts without eval.js!');}else if(!j)throw new Error('Can\'t create a blob URL in this browser!');else{var q=new Blob([p],{type:'text/javascript'}),r=j.createObjectURL(q);o=new h(r)}}catch(s){if(null!==this.options.evalPath)o=new h(this.options.evalPath),o.postMessage(p);else throw s}}return o},c.prototype.spawn=function(m,n){var o=this,p=new b;return n=a(this.options.env,n||{}),this.operation.then(function(){var q=o._spawnWorker(m,n);if(void 0!==q)q.onmessage=function(r){q.terminate(),o.data=r.data,p.resolve(null,o.data)},q.onerror=function(r){q.terminate(),p.resolve(r,null)},q.postMessage(o.data);else if(o.options.synchronous)g(function(){try{o.data=m(o.data),p.resolve(null,o.data)}catch(r){p.resolve(r,null)}});else throw new Error('Workers do not exist and synchronous operation not allowed!')}),this.operation=p,this},c.prototype._spawnMapWorker=function(m,n,o,p,q){var r=this;if(q||(q=r._spawnWorker(n,p)),void 0!==q)q.onmessage=function(s){r.data[m]=s.data,o(null,q)},q.onerror=function(s){q.terminate(),o(s)},q.postMessage(r.data[m]);else if(r.options.synchronous)g(function(){r.data[m]=n(r.data[m]),o()});else throw new Error('Workers do not exist and synchronous operation not allowed!')},c.prototype.map=function(m,n){function o(t,u){t?s.resolve(t,null):++r===p.data.length?(s.resolve(null,p.data),u&&u.terminate()):q<p.data.length?p._spawnMapWorker(q++,m,o,n,u):u&&u.terminate()}if(n=a(this.options.env,n||{}),!this.data.length)return this.spawn(m,n);var p=this,q=0,r=0,s=new b;return this.operation.then(function(){for(;q-r<p.options.maxWorkers&&q<p.data.length;++q)p._spawnMapWorker(q,m,o,n)},function(t){s.resolve(t,null)}),this.operation=s,this},c.prototype._spawnReduceWorker=function(m,n,o,p,q){var r=this;if(q||(q=r._spawnWorker(n,p)),void 0!==q)q.onmessage=function(s){r.data[r.data.length]=s.data,o(null,q)},q.onerror=function(s){q.terminate(),o(s,null)},q.postMessage(m);else if(r.options.synchronous)g(function(){r.data[r.data.length]=n(m),o()});else throw new Error('Workers do not exist and synchronous operation not allowed!')},c.prototype.reduce=function(m,n){function o(s,t){--p,s?r.resolve(s,null):1===q.data.length&&0===p?(q.data=q.data[0],r.resolve(null,q.data),t&&t.terminate()):1<q.data.length?(++p,q._spawnReduceWorker([q.data[0],q.data[1]],m,o,n,t),q.data.splice(0,2)):t&&t.terminate()}if(n=a(this.options.env,n||{}),!this.data.length)throw new Error('Can\'t reduce non-array data');var p=0,q=this,r=new b;return this.operation.then(function(){if(1===q.data.length)r.resolve(null,q.data[0]);else{for(var s=0;s<q.options.maxWorkers&&s<Math.floor(q.data.length/2);++s)++p,q._spawnReduceWorker([q.data[2*s],q.data[2*s+1]],m,o,n);q.data.splice(0,2*s)}}),this.operation=r,this},c.prototype.then=function(m,n){var o=this,p=new b;return n='function'==typeof n?n:function(){},this.operation.then(function(){var q;try{m&&(q=m(o.data),void 0!=q&&(o.data=q)),p.resolve(null,o.data)}catch(r){n?(q=n(r),void 0!=q&&(o.data=q),p.resolve(null,o.data)):p.resolve(null,r)}},function(q){if(n){var r=n(q);void 0!==r&&(o.data=r),p.resolve(null,o.data)}else p.resolve(null,q)}),this.operation=p,this},d?module.exports=c:self.Parallel=c})();